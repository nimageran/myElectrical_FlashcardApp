<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Electrical Drawings Flashcards</title>
  <meta name="theme-color" content="#f0f2f5" />
  <style>
    /* THEME: Futuristic Liquid Metal (Light)
       Palette: Chrome, Silver, Electric Cyan, Deep Slate
    */
    :root {
      --bg: #eef2f6; /* Soft cool grey background */
      --surface: #ffffff;
      --surface-gloss: linear-gradient(135deg, #ffffff 0%, #f3f4f6 100%);
      
      /* Liquid Metal Button Variables */
      --metal-grad: linear-gradient(145deg, #ffffff, #dbe1e8);
      --metal-border: #cbd5e1;
      --metal-shadow: 4px 4px 10px #bfccdb, -4px -4px 10px #ffffff;
      --metal-text: #334155;
      
      --ink: #1e293b;
      --muted: #64748b;
      
      /* Accents */
      --accent: #06b6d4; /* Electric Cyan */
      --accent-grad: linear-gradient(135deg, #06b6d4, #0891b2);
      --accent-ink: #ffffff;
      
      /* Status Colors */
      --ok: #10b981;
      --ok-grad: linear-gradient(135deg, #34d399, #059669);
      --bad: #ef4444;
      --bad-grad: linear-gradient(135deg, #f87171, #dc2626);
      
      --radius: 20px;
      --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --surface: #1e293b;
      --surface-gloss: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      
      --metal-grad: linear-gradient(145deg, #334155, #1e293b);
      --metal-border: #475569;
      --metal-shadow: 5px 5px 15px #0b1120, -5px -5px 15px #2d3f56;
      --metal-text: #e2e8f0;
      
      --ink: #f1f5f9;
      --muted: #94a3b8;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--ink); font-family: var(--font-main); transition: background-color 0.3s, color 0.3s; overflow: hidden; }
    
    .wrap {
      height: 100%;
      max-width: min(800px, 94vw);
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      padding: env(safe-area-inset-top) 0 calc(70px + env(safe-area-inset-bottom));
    }

    /* Header */
    header {
      padding: 16px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 20;
    }
    h1 {
      font-size: clamp(16px, 4vw, 20px);
      margin: 0;
      font-weight: 700;
      letter-spacing: -0.5px;
      background: -webkit-linear-gradient(0deg, var(--ink), var(--muted));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-transform: uppercase;
    }
    .row { display: flex; gap: 10px; align-items: center; }
    .pill {
      padding: 4px 10px;
      border-radius: 99px;
      background: rgba(148, 163, 184, 0.15);
      color: var(--muted);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* Main Card Area */
    main.card-container {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      perspective: 1000px;
      margin: 10px 0;
    }

    .card {
      background: var(--surface);
      background-image: var(--surface-gloss);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 
        0 20px 40px -10px rgba(0,0,0,0.1),
        0 0 0 1px rgba(255,255,255,0.5) inset, /* Glass rim */
        0 0 0 1px var(--metal-border);
      
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      height: 100%;
      max-height: 65vh;
      width: 100%;
      
      will-change: transform;
      user-select: none;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    /* Futuristic Circuit Accent */
    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 4px;
      background: var(--accent-grad);
      opacity: 0.8;
    }

    .big {
      font-size: clamp(20px, 5vw, 32px);
      line-height: 1.4;
      font-weight: 600;
      color: var(--ink);
      white-space: pre-line;
      z-index: 2;
    }
    
    .img {
      max-width: 100%;
      max-height: 40vh;
      margin: 16px auto;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--metal-border);
    }

    /* Liquid Metal Buttons */
    .btn {
      border: none;
      border-radius: 16px;
      padding: 0 20px;
      min-height: 48px;
      min-width: 48px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      color: var(--metal-text);
      background: var(--metal-grad);
      box-shadow: var(--metal-shadow);
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    /* Glossy shine effect on buttons */
    .btn::after {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 100%; height: 50%;
      background: linear-gradient(to bottom, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.1) 100%);
      pointer-events: none;
    }

    .btn:active {
      transform: translateY(2px);
      box-shadow: 2px 2px 5px rgba(0,0,0,0.1), -2px -2px 5px rgba(255,255,255,0.5);
    }

    .btn.primary {
      background: var(--accent-grad);
      color: var(--accent-ink);
      box-shadow: 0 10px 20px -5px rgba(6, 182, 212, 0.4);
    }
    
    .btn.ok {
      background: var(--ok-grad);
      color: white;
      box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.4);
    }
    
    .btn.bad {
      background: var(--bad-grad);
      color: white;
      box-shadow: 0 10px 20px -5px rgba(239, 68, 68, 0.4);
    }
    
    .btn.ghost {
      background: transparent;
      box-shadow: none;
      border: 1px solid transparent;
      color: var(--muted);
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,0.05);
      border-color: rgba(0,0,0,0.1);
    }

    /* Controls at bottom */
    .fabbar {
      position: fixed;
      bottom: 24px;
      left: 0; right: 0;
      display: flex;
      justify-content: center;
      gap: 16px;
      z-index: 30;
      pointer-events: none; /* Let clicks pass through empty space */
    }
    .fabbar .btn {
      pointer-events: auto;
      border-radius: 24px;
      min-width: 120px;
    }

    /* Mark bar inside card for mobile friendliness */
    .markbar {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      width: 100%;
      justify-content: center;
    }
    .markbar .btn {
      flex: 1;
      max-width: 140px;
    }

    /* Animations */
    .flip-anim { transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; }
    .flip-phase { transform: rotateX(90deg) scale(0.95); opacity: 0.8; }
    .flip-reset { transform: rotateX(0deg) scale(1); opacity: 1; }
    
    .swiping { transition: none!important; }
    .swipe-right { transition: transform 0.3s ease, opacity 0.3s ease; transform: translateX(120%) rotate(10deg); opacity: 0; }
    .swipe-left { transition: transform 0.3s ease, opacity 0.3s ease; transform: translateX(-120%) rotate(-10deg); opacity: 0; }

    .hide { display: none!important; }
    
    /* Settings Sheet */
    .sheet {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 50;
      background: rgba(0,0,0,0.2);
      backdrop-filter: blur(4px);
      opacity: 0; pointer-events: none; transition: opacity 0.2s;
      display: flex; justify-content: center; align-items: flex-end;
    }
    .sheet.open { opacity: 1; pointer-events: auto; }
    .sheet-content {
      width: 100%; max-width: 600px;
      background: var(--bg);
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      padding: 24px;
      padding-bottom: max(24px, env(safe-area-inset-bottom));
      max-height: 85vh;
      overflow-y: auto;
      transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
    }
    .sheet.open .sheet-content { transform: translateY(0); }
    
    .sheet h2 { margin: 0 0 20px; font-size: 20px; color: var(--ink); }
    .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .full { grid-column: span 2; }
    
    .fieldset {
      background: var(--surface);
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--metal-border);
    }
    .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; display: block; font-weight: 600; text-transform: uppercase; }
    .select, .range, .chk { width: 100%; }

    /* Helper for keyboard hints */
    .kbd {
      background: rgba(0,0,0,0.05);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.9em;
      border: 1px solid rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<div class="wrap">
  <header>
    <h1>Drawings & Schematics</h1>
    <div class="row">
      <span id="status" class="pill">Loading...</span>
      <button id="openControls" class="btn icon ghost" style="width:40px;height:40px;min-width:auto;min-height:auto">‚öôÔ∏è</button>
    </div>
  </header>

  <main class="card-container" id="cardContainer">
    <div class="card" id="card">
      <div class="row" style="width:100%; justify-content:space-between; position:absolute; top:20px; left:0; padding:0 24px;">
        <span class="pill">ID: <b id="indexLabel">‚Äî</b></span>
        <div class="pill">Tap or Space to Flip</div>
      </div>

      <div id="face" class="big">
        Tap <b>Start</b> to begin.<br><br>
        <small style="color:var(--muted);font-weight:400;font-size:16px;">
          Review electrical symbols, schematic logic, and wiring diagrams.
        </small>
      </div>
      
      <img id="img" class="img hide" alt="" />

      <div class="markbar">
        <button id="again" class="btn bad">Review</button>
        <button id="good" class="btn ok">Mastered</button>
      </div>
    </div>
  </main>
</div>

<div class="fabbar">
  <button id="start" class="btn primary">Start Session</button>
  <button id="next" class="btn hide">Next Card</button>
</div>

<!-- Settings Modal -->
<div id="sheet" class="sheet" aria-hidden="true">
  <div class="sheet-content">
    <div class="row" style="justify-content:space-between; margin-bottom:16px;">
      <h2>Settings</h2>
      <button id="closeSheet" class="btn ghost" style="min-width:40px;">‚úï</button>
    </div>
    
    <div class="controls-grid">
      <div class="fieldset">
        <label class="label">Theme</label>
        <select id="themeSel" class="select" style="width:100%; padding:8px;">
          <option value="light">Liquid Metal (Light)</option>
          <option value="dark">Cyber Dark</option>
        </select>
      </div>
      <div class="fieldset">
        <label class="label">Shuffle</label>
        <select id="mode" class="select" style="width:100%; padding:8px;">
          <option value="random" selected>Random</option>
          <option value="ordered">Ordered</option>
        </select>
      </div>
      <div class="fieldset full">
        <label class="label">Audio</label>
        <div class="row">
          <label><input id="speakFront" type="checkbox"> Speak Front</label>
          <label><input id="speakBack" type="checkbox"> Speak Back</label>
        </div>
      </div>
      <div class="fieldset full">
        <label class="label">Data</label>
        <button id="resetProgress" class="btn ghost" style="width:100%; color:var(--bad)">Reset All Progress</button>
      </div>
      <div class="fieldset full">
        <label class="label">Stats</label>
        <div class="row" style="flex-wrap:wrap; gap:8px;">
          <span class="pill">Known: <b id="statKnown">0</b></span>
          <span class="pill">To Learn: <b id="statUnknown">0</b></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ===== ELECTRICAL DRAWINGS FLASHCARDS CONFIG =====
// Re-branded and isolated from NPPE app

const CSV_URL = 'assets/cards.csv'; 
const STORAGE_KEY = 'elec_drawings_progress_v1';
const AUDIO_KEY = 'elec_audio_prefs_v1';
const THEME_KEY = 'elec_theme_v1';

// Default "Sample" Deck if no CSV is found
const SAMPLE_DECK = `id,front,back
1,Symbol: Zig-zag line,"Resistor (Opposition to current flow)"
2,Symbol: Two parallel lines of equal length,"Capacitor"
3,Symbol: Two parallel lines; one shorter and thicker,"Battery / DC Voltage Source"
4,Symbol: Circle with an 'M',"Motor"
5,NO Contact,"Normally Open (Open circuit when de-energized)"
6,NC Contact,"Normally Closed (Closed circuit when de-energized)"
7,Symbol: Three horizontal lines of decreasing width,"Ground / Earth"
8,Schematic vs Wiring Diagram,"Schematic shows logic/function. Wiring shows physical connections."
9,Symbol: Circle with a cross,"Light Bulb / Lamp"
10,Relay Coil Symbol,"Circle (often with letter K or CR inside)"`;

const DELAY_NEXT_MS = 350; 
const DELAY_FLIP_MS = 800;

let deck = [];
let cursor = -1;
let showingBack = false;
let voices = [];
let audioPrefs = { voiceURI: '', rate: 1.0, speakFront: true, speakBack: false }; // Defaults adjusted for diagrams
let speakTimer = null;
let pending = []; // Queue for immediate re-show
let isFlipping = false;

// DOM Elements
const $ = s => document.querySelector(s);
const cardEl = $('#card');
const face = $('#face');
const img = $('#img');
const status = $('#status');
const startBtn = $('#start');
const nextBtn = $('#next');
const sheet = $('#sheet');
const idxLabel = $('#indexLabel');
const statKnown = $('#statKnown');
const statUnknown = $('#statUnknown');

// Init
(async function init() {
  loadTheme();
  loadAudioPrefs();
  
  // Load Voices
  if ('speechSynthesis' in window) {
    speechSynthesis.onvoiceschanged = () => { voices = speechSynthesis.getVoices(); };
  }

  // Load Data
  try {
    let text;
    try {
      const response = await fetch(CSV_URL);
      if (!response.ok) throw new Error("No CSV");
      text = await response.text();
      status.textContent = 'CSV Loaded';
    } catch {
      text = SAMPLE_DECK;
      status.textContent = 'Ready';
    }
    
    deck = parseCSV(text).map((r, i) => ({
      id: r[0] || `c${i}`,
      front: r[1],
      back: r[2],
      known: false,
      seen: 0
    })).filter(c => c.front && c.back); // Filter empty rows

    loadProgress();
    updateStats();
    
  } catch(e) {
    face.textContent = 'Error: ' + e.message;
  }
})();

// UI Logic
startBtn.addEventListener('click', () => {
  startBtn.classList.add('hide');
  nextBtn.classList.remove('hide');
  next();
  warmUpAudio();
});

nextBtn.addEventListener('click', next);
$('#openControls').addEventListener('click', () => sheet.classList.add('open'));
$('#closeSheet').addEventListener('click', () => sheet.classList.remove('open'));
$('#themeSel').addEventListener('change', (e) => saveTheme(e.target.value));

$('#again').addEventListener('click', (e) => { e.stopPropagation(); grade(false); });
$('#good').addEventListener('click', (e) => { e.stopPropagation(); grade(true); });
$('#card').addEventListener('click', flip);

// Keyboard
document.addEventListener('keydown', e => {
  if(e.key === ' ' || e.key === 'Enter') { e.preventDefault(); flip(); }
  if(e.key === 'ArrowRight') next();
});

// Core Functions
function next() {
  // Logic: 20% chance to see a pending "unknown" card if available, else random
  let pool = deck.filter(c => !c.known);
  
  if (pool.length === 0) {
    face.innerHTML = "üéâ All Cards Mastered!<br><small>Reset progress in settings to restart.</small>";
    hideImage();
    return;
  }

  // Pick card
  const r = Math.floor(Math.random() * pool.length);
  const nextCard = pool[r];
  cursor = deck.findIndex(c => c.id === nextCard.id);
  
  showingBack = false;
  render();
}

function flip() {
  if (isFlipping || cursor < 0) return;
  isFlipping = true;
  cardEl.classList.add('flip-anim', 'flip-phase');
  
  setTimeout(() => {
    showingBack = !showingBack;
    render();
    cardEl.classList.remove('flip-phase');
    cardEl.classList.add('flip-reset');
    setTimeout(() => {
      cardEl.classList.remove('flip-anim', 'flip-reset');
      isFlipping = false;
    }, 250);
  }, 200);
}

function render() {
  const c = deck[cursor];
  idxLabel.textContent = c.id;
  face.innerHTML = showingBack ? escapeHtml(c.back) : escapeHtml(c.front);
  
  // Image handling (basic)
  hideImage();
  if (showingBack) tryShowImage(c.id);

  speakText(showingBack ? c.back : c.front, showingBack ? 'back' : 'front');
}

function grade(isKnown) {
  if (cursor < 0) return;
  deck[cursor].known = isKnown;
  deck[cursor].seen++;
  saveProgress();
  updateStats();
  
  // Visual feedback
  const anim = isKnown ? 'swipe-right' : 'swipe-left';
  cardEl.classList.add(anim);
  setTimeout(() => {
    cardEl.classList.remove(anim);
    next();
  }, 250);
}

// Data & Helpers
function parseCSV(str) {
  // Simple parser assuming id,front,back header
  const lines = str.split('\n').filter(l => l.trim().length > 0);
  const data = [];
  // Skip header if present
  const start = lines[0].toLowerCase().includes('front') ? 1 : 0;
  
  for (let i = start; i < lines.length; i++) {
    // Basic CSV regex to handle quotes
    const parts = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g); 
    // Fallback split if regex fails or simple CSV
    const cols = parts ? parts.map(p => p.replace(/^"|"$/g, '')) : lines[i].split(',');
    if (cols.length >= 2) data.push(cols);
  }
  return data;
}

function saveProgress() {
  const data = deck.map(c => ({ id: c.id, known: c.known, seen: c.seen }));
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function loadProgress() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  const map = new Map(JSON.parse(raw).map(i => [i.id, i]));
  deck.forEach(c => {
    if (map.has(c.id)) {
      c.known = map.get(c.id).known;
      c.seen = map.get(c.id).seen;
    }
  });
}

function updateStats() {
  const k = deck.filter(c => c.known).length;
  statKnown.textContent = k;
  statUnknown.textContent = deck.length - k;
}

function escapeHtml(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Theme
function loadTheme() {
  const t = localStorage.getItem(THEME_KEY) || 'light';
  document.documentElement.setAttribute('data-theme', t);
  $('#themeSel').value = t;
}
function saveTheme(t) {
  localStorage.setItem(THEME_KEY, t);
  document.documentElement.setAttribute('data-theme', t);
}

// Audio
function loadAudioPrefs() {
  try {
    const s = JSON.parse(localStorage.getItem(AUDIO_KEY));
    if(s) Object.assign(audioPrefs, s);
  } catch {}
  $('#speakFront').checked = audioPrefs.speakFront;
  $('#speakBack').checked = audioPrefs.speakBack;
  
  $('#speakFront').addEventListener('change', e => { audioPrefs.speakFront = e.target.checked; saveAudio(); });
  $('#speakBack').addEventListener('change', e => { audioPrefs.speakBack = e.target.checked; saveAudio(); });
}
function saveAudio() { localStorage.setItem(AUDIO_KEY, JSON.stringify(audioPrefs)); }
function warmUpAudio() { if('speechSynthesis' in window) speechSynthesis.speak(new SpeechSynthesisUtterance(' ')); }

function speakText(txt, side) {
  if (!('speechSynthesis' in window)) return;
  const shouldSpeak = side === 'front' ? audioPrefs.speakFront : audioPrefs.speakBack;
  if (!shouldSpeak) return;

  if (speakTimer) clearTimeout(speakTimer);
  speechSynthesis.cancel();
  
  speakTimer = setTimeout(() => {
    const u = new SpeechSynthesisUtterance(txt);
    speechSynthesis.speak(u);
  }, 200);
}

// Basic Image loader for back of card
function tryShowImage(id) {
  img.classList.add('hide');
  // In a real app, you'd know the extension. Here we blindly try PNG then JPG
  img.onerror = () => {
    if (img.src.endsWith('.png')) img.src = `assets/images/${id}.jpg`;
    else if (img.src.endsWith('.jpg')) img.src = `assets/images/${id}.svg`;
  };
  img.onload = () => img.classList.remove('hide');
  img.src = `assets/images/${id}.png`;
}

// Reset Logic
$('#resetProgress').addEventListener('click', () => {
  if(confirm("Reset all progress?")) {
    deck.forEach(c => { c.known = false; c.seen = 0; });
    saveProgress();
    updateStats();
    next();
  }
});
</script>
</body>
</html>
