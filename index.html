<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Component Identification Tool</title>
  <meta name="theme-color" content="#f8fafc" />
  <style>
    /* THEME: Aero-Glass Professional (Light Default) */
    :root {
      /* Backgrounds */
      --bg: #f1f5f9; /* Slate 100 - Lab clean */
      --surface: rgba(255, 255, 255, 0.85); /* Frosted glass effect */
      --surface-gloss: linear-gradient(180deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.5) 100%);
      
      /* Tech Borders */
      --border-color: #cbd5e1;
      --glass-border: 1px solid rgba(255, 255, 255, 0.6);
      
      /* Typography */
      --ink: #0f172a; /* Slate 900 */
      --muted: #64748b; /* Slate 500 */
      --font-main: 'Segoe UI', system-ui, sans-serif;
      --font-tech: 'Consolas', 'Monaco', monospace; /* For IDs and technical data */

      /* Accents (Precision Blue) */
      --accent: #0284c7; 
      --accent-grad: linear-gradient(135deg, #0ea5e9, #0284c7);
      --accent-ink: #ffffff;
      
      /* Status Colors (Muted for professionalism) */
      --ok: #10b981;
      --ok-grad: linear-gradient(135deg, #34d399, #059669);
      --bad: #ef4444;
      --bad-grad: linear-gradient(135deg, #f87171, #dc2626);
      
      /* UI Dimensions */
      --radius: 12px; /* Tighter corners for professional look */
      --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --shadow-lift: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
    }

    /* Dark Mode Override (Cyber-Industrial) */
    [data-theme="dark"] {
      --bg: #0b1120;
      --surface: rgba(30, 41, 59, 0.8);
      --surface-gloss: linear-gradient(180deg, rgba(30,41,59,0.9) 0%, rgba(15,23,42,0.5) 100%);
      --border-color: #334155;
      --ink: #f8fafc;
      --muted: #94a3b8;
      --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--ink); font-family: var(--font-main); transition: background-color 0.3s, color 0.3s; overflow: hidden; }
    
    .wrap {
      height: 100%;
      max-width: min(800px, 94vw);
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      padding: env(safe-area-inset-top) 0 calc(70px + env(safe-area-inset-bottom));
    }

    /* Header */
    header {
      padding: 16px 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 20;
    }
    h1 {
      font-size: 16px;
      margin: 0;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      font-family: var(--font-tech); /* Tech font for header */
    }
    .row { display: flex; gap: 10px; align-items: center; }
    .pill {
      padding: 4px 12px;
      border-radius: 6px; /* Squarer pills */
      background: rgba(148, 163, 184, 0.1);
      color: var(--muted);
      font-size: 11px;
      font-weight: 500;
      font-family: var(--font-tech);
      border: 1px solid var(--border-color);
      backdrop-filter: blur(4px);
    }

    /* Main Card Area */
    main.card-container {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      perspective: 1200px; /* Deeper perspective */
      margin: 10px 0;
    }

    .card {
      background: var(--surface);
      background-image: var(--surface-gloss);
      backdrop-filter: blur(12px); /* Glass effect */
      border-radius: var(--radius);
      padding: 32px;
      box-shadow: var(--shadow-lift), inset 0 0 0 1px rgba(255,255,255,0.4);
      border: 1px solid var(--border-color);
      
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      height: 100%;
      max-height: 70vh; /* Slightly taller */
      width: 100%;
      
      will-change: transform;
      user-select: none;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    /* Tech Accent Line */
    .card::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0; height: 3px;
      background: var(--accent-grad);
      opacity: 0.6;
    }

    .big {
      font-size: clamp(20px, 5vw, 28px);
      line-height: 1.5;
      font-weight: 500;
      color: var(--ink);
      white-space: pre-line;
      z-index: 2;
    }
    
    .img {
      max-width: 100%;
      max-height: 35vh;
      margin: 20px auto;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: #fff; /* Ensure schematic contrast */
      padding: 10px;
    }

    /* Controls / Buttons */
    .btn {
      border: 1px solid var(--border-color);
      border-radius: 8px; /* Consistent geometric radius */
      padding: 0 24px;
      min-height: 44px;
      font-size: 13px;
      font-weight: 600;
      font-family: var(--font-main);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      color: var(--ink);
      background: var(--surface);
      box-shadow: var(--shadow-soft);
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn.primary {
      background: var(--accent-grad);
      color: var(--accent-ink);
      border: none;
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }
    
    .btn.ok {
      background: var(--ok-grad);
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .btn.bad {
      background: var(--bad-grad);
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .btn.ghost {
      background: transparent;
      box-shadow: none;
      border-color: transparent;
      color: var(--muted);
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,0.03);
    }
    
    /* Icon button specific */
    .btn.icon {
      padding: 0;
      width: 40px;
      min-width: 40px;
    }

    /* Layouts */
    .fabbar {
      position: fixed;
      bottom: 24px;
      left: 0; right: 0;
      display: flex;
      justify-content: center;
      gap: 12px;
      z-index: 30;
      pointer-events: none;
    }
    .fabbar .btn {
      pointer-events: auto;
      min-width: 140px;
      backdrop-filter: blur(8px);
    }

    .markbar {
      display: flex;
      gap: 12px;
      margin-top: 32px;
      width: 100%;
      justify-content: center;
    }
    .markbar .btn {
      flex: 1;
      max-width: 140px;
    }

    /* Animations */
    .flip-anim { transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); transform-style: preserve-3d; }
    .flip-phase { transform: rotateX(90deg) scale(0.98); opacity: 0.9; }
    .flip-reset { transform: rotateX(0deg) scale(1); opacity: 1; }
    
    .swiping { transition: none!important; }
    .swipe-right { transition: transform 0.3s ease, opacity 0.3s ease; transform: translateX(100px) rotate(5deg); opacity: 0; }
    .swipe-left { transition: transform 0.3s ease, opacity 0.3s ease; transform: translateX(-100px) rotate(-5deg); opacity: 0; }

    .hide { display: none!important; }
    
    /* Settings Sheet */
    .sheet {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 50;
      background: rgba(15, 23, 42, 0.2);
      backdrop-filter: blur(2px);
      opacity: 0; pointer-events: none; transition: opacity 0.2s;
      display: flex; justify-content: center; align-items: flex-end;
    }
    .sheet.open { opacity: 1; pointer-events: auto; }
    .sheet-content {
      width: 100%; max-width: 600px;
      background: var(--bg);
      border-top: 1px solid var(--border-color);
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      padding: 24px;
      padding-bottom: max(24px, env(safe-area-inset-bottom));
      max-height: 85vh;
      overflow-y: auto;
      transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
    }
    .sheet.open .sheet-content { transform: translateY(0); }
    
    .sheet h2 { margin: 0 0 20px; font-size: 18px; color: var(--ink); font-weight:600; }
    .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .full { grid-column: span 2; }
    
    .fieldset {
      background: var(--surface);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }
    .label { font-size: 11px; color: var(--muted); margin-bottom: 8px; display: block; font-weight: 700; text-transform: uppercase; letter-spacing:0.5px; }
    .select, .range, .chk { width: 100%; padding: 4px; border: 1px solid var(--border-color); border-radius: 4px; background:transparent; color: var(--ink); }

  </style>
</head>
<body>

<div class="wrap">
  <header>
    <h1>Component Database</h1>
    <div class="row">
      <span id="status" class="pill">System Check...</span>
      <button id="openControls" class="btn icon ghost">⚙️</button>
    </div>
  </header>

  <main class="card-container" id="cardContainer">
    <div class="card" id="card">
      <div class="row" style="width:100%; justify-content:space-between; position:absolute; top:24px; left:0; padding:0 32px;">
        <span class="pill">REF: <b id="indexLabel" style="font-family:var(--font-tech)">—</b></span>
        <div class="pill">Tap / Space to Scan</div>
      </div>

      <div id="face" class="big">
        Initialize Session.<br><br>
        <small style="color:var(--muted);font-weight:400;font-size:15px; font-family: var(--font-main);">
          Identify standard electrical components and symbols.
        </small>
      </div>
      
      <img id="img" class="img hide" alt="" />

      <div class="markbar">
        <button id="again" class="btn bad">Re-Evaluate</button>
        <button id="good" class="btn ok">Verified</button>
      </div>
    </div>
  </main>
</div>

<div class="fabbar">
  <button id="start" class="btn primary">Start Session</button>
  <button id="next" class="btn hide">Next Component</button>
</div>

<div id="sheet" class="sheet" aria-hidden="true">
  <div class="sheet-content">
    <div class="row" style="justify-content:space-between; margin-bottom:16px;">
      <h2>Configuration</h2>
      <button id="closeSheet" class="btn ghost icon">✕</button>
    </div>
    
    <div class="controls-grid">
      <div class="fieldset">
        <label class="label">Interface Mode</label>
        <select id="themeSel" class="select">
          <option value="light">Aero Light (Default)</option>
          <option value="dark">Cyber Industrial</option>
        </select>
      </div>
      <div class="fieldset">
        <label class="label">Sequence</label>
        <select id="mode" class="select">
          <option value="random" selected>Randomized</option>
          <option value="ordered">Sequential</option>
        </select>
      </div>
      <div class="fieldset full">
        <label class="label">Audio Readout</label>
        <div class="row">
          <label><input id="speakFront" type="checkbox"> Read Query</label>
          <label><input id="speakBack" type="checkbox"> Read Data</label>
        </div>
      </div>
      <div class="fieldset full">
        <label class="label">Database</label>
        <button id="resetProgress" class="btn ghost" style="width:100%; color:var(--bad)">Clear Cache & Reset</button>
      </div>
      <div class="fieldset full">
        <label class="label">Session Stats</label>
        <div class="row" style="flex-wrap:wrap; gap:8px;">
          <span class="pill">Verified: <b id="statKnown" style="color:var(--ok)">0</b></span>
          <span class="pill">Pending: <b id="statUnknown" style="color:var(--accent)">0</b></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ===== COMPONENT DATABASE LOGIC =====

const CSV_URL = 'assets/cards.csv'; 
const STORAGE_KEY = 'elec_comp_progress_v1';
const AUDIO_KEY = 'elec_comp_audio_v1';
const THEME_KEY = 'elec_comp_theme_v1';

// Default "Sample" Deck adapted for Electrical Components
const SAMPLE_DECK = `id,front,back
1,"Component: Reduces current flow, divides voltage","Resistor"
2,"Component: Stores electrical energy in an electric field","Capacitor"
3,"Component: Stores energy in a magnetic field, opposes change in current","Inductor"
4,"Component: Allows current to flow in only one direction","Diode"
5,"Component: Electrically operated switch used to control a circuit","Relay"
6,"Component: Converts electrical energy into mechanical motion","Electric Motor"
7,"Component: Protects circuit by melting when current is too high","Fuse"
8,"Component: Semiconductor device used to amplify or switch signals","Transistor"
9,"Component: Step-up or step-down AC voltage levels","Transformer"
10,"Component: Measures electrical potential difference","Voltmeter"`;

const DELAY_NEXT_MS = 350; 
const DELAY_FLIP_MS = 800;

let deck = [];
let cursor = -1;
let showingBack = false;
let voices = [];
let audioPrefs = { voiceURI: '', rate: 1.0, speakFront: true, speakBack: false };
let speakTimer = null;
let pending = []; 
let isFlipping = false;

// DOM Elements
const $ = s => document.querySelector(s);
const cardEl = $('#card');
const face = $('#face');
const img = $('#img');
const status = $('#status');
const startBtn = $('#start');
const nextBtn = $('#next');
const sheet = $('#sheet');
const idxLabel = $('#indexLabel');
const statKnown = $('#statKnown');
const statUnknown = $('#statUnknown');

// Init
(async function init() {
  loadTheme();
  loadAudioPrefs();
  
  if ('speechSynthesis' in window) {
    speechSynthesis.onvoiceschanged = () => { voices = speechSynthesis.getVoices(); };
  }

  // Load Data
  try {
    let text;
    try {
      const response = await fetch(CSV_URL);
      if (!response.ok) throw new Error("No CSV");
      text = await response.text();
      status.textContent = 'DB Loaded';
    } catch {
      text = SAMPLE_DECK;
      status.textContent = 'Standby';
    }
    
    deck = parseCSV(text).map((r, i) => ({
      id: r[0] || `c${i}`,
      front: r[1],
      back: r[2],
      known: false,
      seen: 0
    })).filter(c => c.front && c.back);

    loadProgress();
    updateStats();
    
  } catch(e) {
    face.textContent = 'Error: ' + e.message;
  }
})();

// UI Logic
startBtn.addEventListener('click', () => {
  startBtn.classList.add('hide');
  nextBtn.classList.remove('hide');
  next();
  warmUpAudio();
});

nextBtn.addEventListener('click', next);
$('#openControls').addEventListener('click', () => sheet.classList.add('open'));
$('#closeSheet').addEventListener('click', () => sheet.classList.remove('open'));
$('#themeSel').addEventListener('change', (e) => saveTheme(e.target.value));

$('#again').addEventListener('click', (e) => { e.stopPropagation(); grade(false); });
$('#good').addEventListener('click', (e) => { e.stopPropagation(); grade(true); });
$('#card').addEventListener('click', flip);

// Keyboard
document.addEventListener('keydown', e => {
  if(e.key === ' ' || e.key === 'Enter') { e.preventDefault(); flip(); }
  if(e.key === 'ArrowRight') next();
});

// Core Functions
function next() {
  let pool = deck.filter(c => !c.known);
  
  if (pool.length === 0) {
    face.innerHTML = "✅ Database Complete.<br><small>All components verified.</small>";
    hideImage();
    return;
  }

  const r = Math.floor(Math.random() * pool.length);
  const nextCard = pool[r];
  cursor = deck.findIndex(c => c.id === nextCard.id);
  
  showingBack = false;
  render();
}

function flip() {
  if (isFlipping || cursor < 0) return;
  isFlipping = true;
  cardEl.classList.add('flip-anim', 'flip-phase');
  
  setTimeout(() => {
    showingBack = !showingBack;
    render();
    cardEl.classList.remove('flip-phase');
    cardEl.classList.add('flip-reset');
    setTimeout(() => {
      cardEl.classList.remove('flip-anim', 'flip-reset');
      isFlipping = false;
    }, 250);
  }, 200);
}

function render() {
  const c = deck[cursor];
  idxLabel.textContent = c.id;
  face.innerHTML = showingBack ? escapeHtml(c.back) : escapeHtml(c.front);
  
  hideImage();
  if (showingBack) tryShowImage(c.id);

  speakText(showingBack ? c.back : c.front, showingBack ? 'back' : 'front');
}

function grade(isKnown) {
  if (cursor < 0) return;
  deck[cursor].known = isKnown;
  deck[cursor].seen++;
  saveProgress();
  updateStats();
  
  const anim = isKnown ? 'swipe-right' : 'swipe-left';
  cardEl.classList.add(anim);
  setTimeout(() => {
    cardEl.classList.remove(anim);
    next();
  }, 250);
}

function hideImage() { img.classList.add('hide'); img.removeAttribute('src'); }

function parseCSV(str) {
  const lines = str.split('\n').filter(l => l.trim().length > 0);
  const data = [];
  const start = lines[0].toLowerCase().includes('front') ? 1 : 0;
  
  for (let i = start; i < lines.length; i++) {
    const parts = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g); 
    const cols = parts ? parts.map(p => p.replace(/^"|"$/g, '')) : lines[i].split(',');
    if (cols.length >= 2) data.push(cols);
  }
  return data;
}

function saveProgress() {
  const data = deck.map(c => ({ id: c.id, known: c.known, seen: c.seen }));
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function loadProgress() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  const map = new Map(JSON.parse(raw).map(i => [i.id, i]));
  deck.forEach(c => {
    if (map.has(c.id)) {
      c.known = map.get(c.id).known;
      c.seen = map.get(c.id).seen;
    }
  });
}

function updateStats() {
  const k = deck.filter(c => c.known).length;
  statKnown.textContent = k;
  statUnknown.textContent = deck.length - k;
}

function escapeHtml(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function loadTheme() {
  const t = localStorage.getItem(THEME_KEY) || 'light';
  document.documentElement.setAttribute('data-theme', t);
  $('#themeSel').value = t;
}
function saveTheme(t) {
  localStorage.setItem(THEME_KEY, t);
  document.documentElement.setAttribute('data-theme', t);
}

function loadAudioPrefs() {
  try {
    const s = JSON.parse(localStorage.getItem(AUDIO_KEY));
    if(s) Object.assign(audioPrefs, s);
  } catch {}
  $('#speakFront').checked = audioPrefs.speakFront;
  $('#speakBack').checked = audioPrefs.speakBack;
  
  $('#speakFront').addEventListener('change', e => { audioPrefs.speakFront = e.target.checked; saveAudio(); });
  $('#speakBack').addEventListener('change', e => { audioPrefs.speakBack = e.target.checked; saveAudio(); });
}
function saveAudio() { localStorage.setItem(AUDIO_KEY, JSON.stringify(audioPrefs)); }
function warmUpAudio() { if('speechSynthesis' in window) speechSynthesis.speak(new SpeechSynthesisUtterance(' ')); }

function speakText(txt, side) {
  if (!('speechSynthesis' in window)) return;
  const shouldSpeak = side === 'front' ? audioPrefs.speakFront : audioPrefs.speakBack;
  if (!shouldSpeak) return;

  if (speakTimer) clearTimeout(speakTimer);
  speechSynthesis.cancel();
  
  speakTimer = setTimeout(() => {
    const u = new SpeechSynthesisUtterance(txt);
    speechSynthesis.speak(u);
  }, 200);
}

function tryShowImage(id) {
  img.classList.add('hide');
  img.onerror = () => {
    if (img.src.endsWith('.png')) img.src = `assets/images/${id}.jpg`;
    else if (img.src.endsWith('.jpg')) img.src = `assets/images/${id}.svg`;
  };
  img.onload = () => img.classList.remove('hide');
  img.src = `assets/images/${id}.png`;
}

$('#resetProgress').addEventListener('click', () => {
  if(confirm("Clear local cache and reset database?")) {
    deck.forEach(c => { c.known = false; c.seen = 0; });
    saveProgress();
    updateStats();
    next();
  }
});
</script>
</body>
</html>
